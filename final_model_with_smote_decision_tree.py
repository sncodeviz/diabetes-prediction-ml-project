# -*- coding: utf-8 -*-
"""final_model_with_SMOTE_decision_tree.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1j3pFHsQt3gJQSpKL0nF3DtM7pmgvzHYR

# Final Model Decision Tree with SMOTE
"""

!pip install imbalanced-learn scikit-learn pandas numpy joblib

# Load Libraries
import numpy as np
import pandas as pd

from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler, OneHotEncoder
from sklearn.impute import SimpleImputer
from sklearn.compose import ColumnTransformer
from sklearn.pipeline import Pipeline
from sklearn.tree import DecisionTreeClassifier
from sklearn.metrics import classification_report, confusion_matrix

from imblearn.over_sampling import SMOTE

import joblib

# Dataset Load
df = pd.read_csv("diabetes_prediction_dataset.csv")

# Define features and target
# Target, Numeric & Categorical Columns
numeric_features = ['age', 'bmi', 'HbA1c_level', 'blood_glucose_level']
categorical_features = ['gender', 'smoking_history', 'hypertension', 'heart_disease']
target = 'diabetes'

# X = all features; y = target
X = df[numeric_features + categorical_features]
y = df[target]

# Train/Test Split
X_train, X_test, y_train, y_test = train_test_split(
    X, y,
    test_size=0.20,
    random_state=42,
    stratify=y
)

print("Data Split Complete!")
print(f"   Training set: {len(X_train)}")
print(f"   Testing set: {len(X_test)}")
print(f"   Number of features: {X_train.shape[1]}")
print(f"   Shape of Train & Test Data: {X_train.shape, X_test.shape}")

# Numeric pipeline
numeric_transformer = Pipeline(steps=[
    ('imputer', SimpleImputer(strategy='median')),
    ('scaler', StandardScaler())
])

# Categorical pipeline
categorical_transformer = Pipeline(steps=[
    ('imputer', SimpleImputer(strategy='most_frequent')),
    ('onehot', OneHotEncoder(handle_unknown='ignore'))
])

# Combine into a ColumnTransformer
preprocessor = ColumnTransformer(
    transformers=[
        ('num', numeric_transformer, numeric_features),
        ('cat', categorical_transformer, categorical_features)
    ]
)

print("Preprocessing pipeline created.")

# 1) Fit the preprocessor on TRAIN only
X_train_proc = preprocessor.fit_transform(X_train)
X_test_proc = preprocessor.transform(X_test)

print("Shapes after preprocessing:")
print("   X_train_proc:", X_train_proc.shape)
print("   X_test_proc:", X_test_proc.shape)

# 2) Apply SMOTE on the processed training data
smote = SMOTE(random_state=42)
X_train_res, y_train_res = smote.fit_resample(X_train_proc, y_train)

# Final Decision Tree hyperparameters
clf = DecisionTreeClassifier(
    max_depth=6,
    min_samples_split=4,
    min_samples_leaf=2,
    random_state=42
)

# Fit on SMOTE-resampled numeric data
clf.fit(X_train_res, y_train_res)

# Evaluate on original test set (preprocessed but NOT resampled)
y_pred_dt = clf.predict(X_test_proc)

print("Decision Tree (trained on SMOTE-resampled training data)")
print("\nClassification Report:")
print(classification_report(y_test, y_pred_dt))

print("Confusion Matrix:")
print(confusion_matrix(y_test, y_pred_dt))

# Fitted preprocessor + classifier into a sklearn Pipeline
from sklearn.pipeline import Pipeline

dt_pipeline_final = Pipeline(steps=[
    ('preprocessor', preprocessor),
    ('classifier', clf)
])

import joblib
joblib.dump(dt_pipeline_final, "diabetes_dt_smote_final.pkl")